{% extends "base.html" %}

{% block title %}Subscribe - SignalNet{% endblock %}
{% block breadcrumbs %}
<li class="breadcrumb-item active" aria-current="page">Subscribe</li>
{% endblock %}
{% block content %}
    <!-- Flash Messages are handled in base.html -->

    <!-- Scoped Styles for Subscribe Page -->
    <style>
        /* Subscribe Page Container */
        .subscribe-page {
            font-family: 'Silkscreen', sans-serif;
            background-color: #ffffff;
            color: #333333;
            padding: 20px;
        }
        
        /* Professional Info Section */
        .subscribe-page .professional-info {
            background-color: #f0f4f8;
            padding: 40px 20px;
            text-align: center;
            border-radius: 8px;
            margin: 40px 0;
        }
        
        .subscribe-page .professional-info h2 {
            font-size: 32px;
            margin-bottom: 20px;
            color: #333333;
        }
        
        .subscribe-page .professional-info p {
            font-size: 18px;
            color: #555555;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* Features Section */
        .subscribe-page .features {
            background-color: #ffffff;
            padding: 40px 20px;
            border-radius: 8px;
            margin: 40px 0;
        }
        
        .subscribe-page .features h2 {
            font-size: 32px;
            margin-bottom: 30px;
            color: #333333;
        }
        
        .subscribe-page .features-list {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding-left: 0;
        }
        
        .subscribe-page .features-list li {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 18px;
            color: #555555;
            max-width: 800px;
            text-align: left;
        }
        
        .subscribe-page .features-list li i {
            margin-right: 10px;
            color: #28a745;
        }
        
        /* Security Section */
        .subscribe-page .security {
            background-color: #f0f4f8;
            padding: 40px 20px;
            border-radius: 8px;
            margin: 40px 0;
        }
        
        .subscribe-page .security h2 {
            font-size: 32px;
            margin-bottom: 20px;
            color: #333333;
        }
        
        .subscribe-page .security p {
            font-size: 18px;
            color: #555555;
            max-width: 800px;
            margin: 0 auto 20px auto;
            line-height: 1.6;
        }
        
        .subscribe-page .security ul {
            list-style: disc inside;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
        }
        
        .subscribe-page .security ul li {
            font-size: 18px;
            color: #555555;
            margin-bottom: 10px;
        }
        
        /* Legal Section */
        .subscribe-page .legal {
            background-color: #ffffff;
            padding: 40px 20px;
            border-radius: 8px;
            margin: 40px 0;
        }
        
        .subscribe-page .legal h2 {
            font-size: 32px;
            margin-bottom: 20px;
            color: #333333;
        }
        
        .subscribe-page .legal p {
            font-size: 18px;
            color: #555555;
            max-width: 800px;
            margin: 0 auto 20px auto;
            line-height: 1.6;
        }
        
        .subscribe-page .legal ul {
            list-style: none;
            padding: 0;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .subscribe-page .legal ul li {
            margin-bottom: 10px;
        }
        
        .subscribe-page .legal ul li a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        
        .subscribe-page .legal ul li a:hover {
            text-decoration: underline;
        }
        
        /* Financial Disclaimer Section */
        .subscribe-page .financial-disclaimer {
            background-color: #fff3cd;
            padding: 40px 20px;
            border-radius: 8px;
            margin: 40px 0;
            border-left: 6px solid #ffeeba;
        }
        
        .subscribe-page .financial-disclaimer h2 {
            font-size: 32px;
            margin-bottom: 20px;
            color: #856404;
        }
        
        .subscribe-page .financial-disclaimer p {
            font-size: 18px;
            color: #856404;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* Testimonials Section */
        .subscribe-page .testimonials {
            background-color: #f9f9f9;
            padding: 20px;
            margin-bottom: 40px;
            border-radius: 5px;
        }
        
        .subscribe-page .testimonials h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        
        .subscribe-page .testimonial {
            max-width: 800px;
            margin: 0 auto 20px auto;
            font-style: italic;
            color: #555;
        }
        
        .subscribe-page .testimonial span {
            display: block;
            text-align: right;
            margin-top: 10px;
            font-weight: bold;
            color: #333;
        }
        
        /* Call-to-Action Section */
        .subscribe-page .call-to-action {
            background-color: #f0f4f8;
            padding: 60px 20px;
            border-radius: 8px;
            text-align: center;
            margin: 40px 0;
        }
        
        .subscribe-page .call-to-action h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #333333;
        }
        
        .subscribe-page .call-to-action p {
            font-size: 20px;
            color: #555555;
            margin-bottom: 30px;
        }
        
        .subscribe-page .call-to-action .cta-button {
            background-color: #28a745;
            color: #fff;
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 5px;
            font-size: 18px;
            transition: background-color 0.3s ease;
        }
        
        .subscribe-page .call-to-action .cta-button:hover {
            background-color: #218838;
        }
        
        /* Responsive Styles for Subscribe Page */
        @media (max-width: 768px) {
            .subscribe-page .features-list {
                align-items: flex-start;
            }
        
            .subscribe-page .features-list li {
                max-width: 100%;
            }
        
            .subscribe-page .security ul {
                padding-left: 20px;
            }
        }
        /* Financial Disclaimer Styling */
        .financial-disclaimer-popup {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 10%;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px;
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
}

.financial-disclaimer-popup .popup-content {
    background-color: #333;
    padding: 10px 20px; /* Reduced padding */
    border-radius: 8px;
    position: relative;
    max-width: 80%; /* Increased max-width from 600px to 80% */
    width: 100%;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    justify-content: center;
    height: 100%; /* Ensure popup content fills the popup height */
}

.financial-disclaimer-popup .close-button {
    position: absolute;
    top: 5px;
    right: 10px;
    color: #fff;
    font-size: 18px; /* Reduced font size */
    font-weight: bold;
    cursor: pointer;
}


.financial-disclaimer-popup .close-button:hover {
    color: #ffdddd;
}
.financial-disclaimer-popup h2 {
    font-size: 16px; /* Reduced font size */
    margin-bottom: 5px;
}

.financial-disclaimer-popup p {
    font-size: 12px; /* Reduced font size */
    line-height: 1.4;
    margin: 0;
}

/* Responsive Adjustments */
@media (max-width: 600px) {
    .financial-disclaimer-popup {
        height: 15vh; /* Slightly larger for small screens */
    }

    .financial-disclaimer-popup .popup-content {
        padding: 8px 15px;
        max-width: 90%;
    }

    .financial-disclaimer-popup h2 {
        font-size: 14px;
    }

    .financial-disclaimer-popup p {
        font-size: 11px;
    }
}

        /* One-Time Purchase Section Styles */
        .subscribe-page .one-time-purchase-section {
            background-color: #ffffff;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .subscribe-page .one-time-purchase-section h2 {
            font-size: 32px;
            margin-bottom: 30px;
            color: #333333;
            text-align: center;
        }

        .subscribe-page .one-time-plans {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .subscribe-page .one-time-plan {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            width: 220px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .subscribe-page .one-time-plan:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.2);
        }

        .subscribe-page .one-time-plan h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #343a40;
        }

        .subscribe-page .one-time-plan .price {
            font-size: 18px;
            color: #495057;
            margin-bottom: 15px;
        }

        .subscribe-page .one-time-plan .model-select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .subscribe-page .one-time-plan .purchase-button {
            background-color: #28a745;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
        }

        .subscribe-page .one-time-plan .purchase-button:hover {
            background-color: #218838;
        }

        .subscribe-page .savings-info {
            margin-top: 15px;
            font-size: 14px;
            color: #6c757d;
            text-align: center;
        }

        /* Responsive Styles for One-Time Purchase Section */
        @media (max-width: 768px) {
            .subscribe-page .one-time-plans {
                flex-direction: column;
                align-items: center;
            }

            .subscribe-page .one-time-plan {
                width: 100%;
                max-width: 300px;
            }
        }

        /* Quick Entrance Section Styling */
        .quick-entrance {
            background-color: #f0f4f8;
            padding: 40px 20px;
            border-radius: 8px;
            margin: 40px 0;
        }

        .technology-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .technology-text {
            flex: 1;
            padding-right: 20px;
        }

        .technology-text h3 {
            font-size: 28px;
            margin-bottom: 15px;
            color: #333333;
        }

        .technology-text p {
            font-size: 18px;
            color: #555555;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        /* Enhanced Button Styling */
        .technology-link {
            display: inline-block;
            background-color: #28a745;
            color: #fff;
            padding: 14px 30px;
            text-decoration: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .technology-link:hover,
        .technology-link:focus {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            color: #fff; /* Override global a:hover color */
            text-decoration: none; /* Remove underline from global a:hover */
        }

        .technology-link:active {
            background-color: #1e7e34;
            transform: translateY(0);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .technology-link:focus {
            outline: 2px solid #005f3a;
            outline-offset: 2px;
        }

        .technology-image {
            flex: 1;
            padding-left: 20px;
            text-align: center;
        }

        .entrance-image {
            max-width: 70%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
            .technology-container {
                flex-direction: column;
                align-items: center;
            }

            .technology-text, .technology-image {
                padding: 0;
            }

            .technology-text {
                margin-bottom: 20px;
                text-align: center;
            }

            .technology-link {
                padding: 12px 25px;
                font-size: 16px;
            }
        }

        @media (max-width: 600px) {
            .technology-text h3 {
                font-size: 24px;
            }

            .technology-text p {
                font-size: 16px;
            }

            .technology-link {
                font-size: 14px;
                padding: 10px 20px;
            }
        }
    </style>

    <!-- Subscribe Page Content Wrapped in Unique Container -->
    <div class="subscribe-page">
        <section>
            <h2>Choose Your Plan</h2>
            <form method="POST" id="subscribe-form">
                {{ form.hidden_tag() }}
                <div class="plans">
                    {% for subscription in subscriptions %}
                    <div class="plan {% if current_user.subscription_id == subscription.id %}current-plan{% endif %} {% if subscription.name == 'Pro' %}most-popular{% endif %}">
                        <h3>
                            {{ subscription.name }}
                            {% if subscription.name == 'Pro' %}
                                <span class="best-value-text">Best Value</span>
                            {% endif %}
                        </h3>
                        <p class="price">
                            {% if subscription.name == 'Pro' %}
                                <span class="original-price">$29.99</span> ${{ subscription.price }}/month
                            {% else %}
                                ${{ subscription.price }}/month
                            {% endif %}
                        </p>
                        <ul>
                            {% for feature in subscription.features.split(',') %}
                            <li><i class="fas fa-check-circle"></i> {{ feature }}</li>
                            {% endfor %}
                        </ul>
                        {% if current_user.subscription_id == subscription.id %}
                            <button type="button" class="subscribe-button current-plan-button" disabled>
                                Current Plan
                            </button>
                        {% else %}
                            <button type="submit" class="subscribe-button subscribe-button-{{ subscription.id }}" name="subscription" value="{{ subscription.name }}">
                                Subscribe
                            </button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                <div id="loading" style="display:none;">
                    <p>Processing your subscription...</p>
                </div>
            </form>
        </section>

        <!-- One-Time Purchase Section -->
        <section class="one-time-purchase-section">
            <h2>Buy Signals</h2>
            <div class="one-time-plans">
                {% for plan in one_time_plans %}
                <div class="one-time-plan">
                    <h3>{{ plan.name }}</h3>
                    <p class="price" data-base-price="{{ plan.base_price }}" data-signals="{{ plan.signals }}">
                        ${{ '%.2f'|format(plan.base_price) }} for {{ plan.signals }} Signals
                    </p>
                    <form method="POST" class="buy-one-time-form" data-plan-id="{{ plan.id }}">
                        {{ one_time_purchase_form.hidden_tag() }}
                        <div class="form-group">
                            <label for="model_{{ plan.id }}">Choose Model:</label>
                            <select name="model_{{ plan.id }}" id="model_{{ plan.id }}" class="model-select" data-plan-id="{{ plan.id }}">
                                {% for model in plan.models %}
                                <option value="{{ model.id }}" data-cost-per-signal="{{ model.cost_per_signal }}">
                                    {{ model.name }} {% if model.cost_per_signal > 0 %}+ ${{ '%.2f'|format(model.cost_per_signal) }}/signal{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="purchase-button">Buy Now</button>
                        <div class="loading-one-time" style="display:none;">
                            <p>Processing your purchase...</p>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
            <p class="savings-info">* Subscriptions offer better value and unlimited signals. Consider subscribing for ongoing access.</p>
            <p class="savings-info">* For one-time purchases, you can choose different analysis models which may affect the final price.</p>
        </section>

        <!-- New Professional Information Sections Below Subscription Plans -->

        <!-- Quick Entrance Section -->
        <section class="quick-entrance">
            <div class="technology-container">
                <div class="technology-text">
                    <h3>Discover Our Technology</h3>
                    <p>
                        Learn how our advanced trading algorithms and machine learning models work together to provide you with accurate and reliable market signals. 
                        Our technology is designed to give you a competitive edge in the financial markets.
                    </p>
                    <a href="{{ url_for('main.technology') }}" class="technology-link" role="button">Learn More About Our Technology</a>
                </div>
                <div class="technology-image">
                    <img src="{{ url_for('static', filename='images/web.png') }}" alt="Our Trading Technology" class="entrance-image" loading="lazy">
                </div>
            </div>
        </section>

        <section class="features">
            <h2>Our Features</h2>
            <ul class="features-list">
                <li><i class="fas fa-check-circle"></i>Real-Time Signals: Stay ahead with up-to-the-minute trading signals.</li>
                <li><i class="fas fa-check-circle"></i>Comprehensive Analysis: Detailed trend analyses and moving averages to guide your strategies.</li>
                <li><i class="fas fa-check-circle"></i>Secure Transactions: Your data and payments are protected with industry-standard security protocols.</li>
                <li><i class="fas fa-check-circle"></i>24/7 Support: Our dedicated support team is available around the clock to assist you.</li>
                <li><i class="fas fa-check-circle"></i>Flexible Plans: Choose a subscription that aligns with your trading frequency and investment goals.</li>
            </ul>
        </section>

        <section class="security">
            <h2>Security You Can Trust</h2>
            <p>Your security is paramount to us. SignalNet employs robust security measures to safeguard your personal information and financial transactions:</p>
            <ul>
                <li><strong>Data Encryption:</strong> All sensitive data is encrypted using advanced encryption standards to prevent unauthorized access.</li>
                <li><strong>Secure Payment Gateways:</strong> We integrate with trusted payment providers, ensuring your financial information is handled securely.</li>
                <li><strong>Regular Security Audits:</strong> Continuous monitoring and regular security audits help us identify and mitigate potential vulnerabilities.</li>
                <li><strong>Compliance:</strong> We adhere to all relevant industry standards and regulations to maintain the highest level of security.</li>
            </ul>
        </section>

        <section class="legal">
            <h2>Terms and Conditions</h2>
            <p>By subscribing to SignalNet, you agree to our comprehensive terms and conditions. Please read them carefully to understand your rights and obligations:</p>
            <ul>
                <li><a href="{{ url_for('main.terms_of_service') }}">Read our Terms of Service</a></li>
                <li><a href="{{ url_for('main.privacy') }}">Review our Privacy Policy</a></li>
                <li><a href="{{ url_for('main.cookie_policy') }}">Understand our Cookie Policy</a></li>
            </ul>
            <p>Ensure you fully comprehend all terms before proceeding with your subscription to make informed decisions.</p>
        </section>

        <!-- Financial Disclaimer Popup -->
        <div id="financial-disclaimer-popup" class="financial-disclaimer-popup">
            <div class="popup-content">
                <span class="close-button">&times;</span>
        <h2>Financial Disclaimer</h2>
        <p>
            All financial market signals provided by SignalNet are for informational purposes only and do not constitute financial, investment, or trading advice.
            Trading involves significant risk, including the potential loss of your entire investment. Always consult with a qualified financial advisor before making any financial decisions.
        </p>
            </div>
        </div>

        <section class="testimonials">
            <h2>What Our Subscribers Say</h2>
            <div class="testimonial">
                "SignalNet has transformed my trading strategy. The real-time signals are incredibly accurate and have significantly boosted my trading performance."
                <span>- Alex T., Professional Trader</span>
            </div>
            <div class="testimonial">
                "The comprehensive analysis and 24/7 support make SignalNet a reliable partner in my trading journey."
                <span>- Maria K., Investment Analyst</span>
            </div>
        </section>

        <section class="call-to-action">
            <h2>Ready to Elevate Your Trading?</h2>
            <p>Join thousands of satisfied traders who trust SignalNet for reliable market insights and signals.</p>
            <a href="{{ url_for('main.subscribe') }}" class="cta-button">Choose Your Plan Now</a>
        </section>
    </div>

    <script src="https://js.stripe.com/v3/"></script> <!-- Ensure Stripe.js is loaded -->

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const stripe = Stripe('{{ stripe_public_key }}'); // Use the passed Stripe publishable key

        // Handle subscription form submission
        const subscribeForm = document.getElementById('subscribe-form');

        subscribeForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent the default form submission

            // Use the submitter property to identify which button was clicked
            const submitter = e.submitter;
            const selectedPlan = submitter.value;

            if (!selectedPlan) {
                alert('Please select a subscription plan.');
                return;
            }

            // Show loading indicator
            document.getElementById('loading').style.display = 'block';

            fetch('/create-checkout-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}' // Ensure CSRF token is included
                },
                body: JSON.stringify({ subscription: selectedPlan })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(session) {
                if (session.error) {
                    throw new Error(session.error);
                }
                // Redirect to Stripe Checkout
                window.location.href = session.url;
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('An unexpected error occurred.');
                document.getElementById('loading').style.display = 'none';
            });
        });

        // Handle one-time purchase form submissions
        const oneTimePurchaseForms = document.querySelectorAll('.buy-one-time-form');

        oneTimePurchaseForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const loadingIndicator = form.querySelector('.loading-one-time');
                const modelSelect = form.querySelector('.model-select');
                const planId = form.getAttribute('data-plan-id');
                const selectedModelId = modelSelect.value;

                if (!selectedModelId) {
                    alert('Please select an analysis model.');
                    return;
                }

                // Show loading indicator
                loadingIndicator.style.display = 'block';

                // Prepare data to send
                const data = {
                    selected_models: {
                        [planId]: selectedModelId
                    }
                };

                fetch('/buy-signals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    loadingIndicator.style.display = 'none';
                    if (data.url) {
                        window.location.href = data.url;
                    } else if (data.error) {
                        alert(data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingIndicator.style.display = 'none';
                    alert('An unexpected error occurred.');
                });
            });
        });

        // Financial Disclaimer Popup Logic
        const disclaimerPopup = document.getElementById('financial-disclaimer-popup');
        if (disclaimerPopup) {
            const closeButton = disclaimerPopup.querySelector('.close-button');

            // Show the popup when the page loads
            disclaimerPopup.style.display = 'flex';

            // Close the popup when the close button is clicked
            closeButton.addEventListener('click', function() {
                disclaimerPopup.style.display = 'none';
            });

            // Optional: Close the popup when clicking outside the popup content
            window.addEventListener('click', function(event) {
                if (event.target === disclaimerPopup) {
                    disclaimerPopup.style.display = 'none';
                }
            });
        }

        // Handle dynamic price updates based on model selection
        const modelSelects = document.querySelectorAll('.model-select');

        function updatePrices(modelSelectElement) {
            const planElement = modelSelectElement.closest('.one-time-plan');
            const basePriceElement = planElement.querySelector('.price');
            const basePrice = parseFloat(basePriceElement.getAttribute('data-base-price'));
            const signals = parseInt(basePriceElement.getAttribute('data-signals'));
            const selectedModel = modelSelectElement.selectedOptions[0];
            const costPerSignal = parseFloat(selectedModel.getAttribute('data-cost-per-signal'));

            if (isNaN(basePrice) || isNaN(signals) || isNaN(costPerSignal)) {
                console.error('Invalid data for price calculation.');
                return;
            }

            const additionalCost = signals * costPerSignal;
            const newPrice = basePrice + additionalCost;
            basePriceElement.textContent = `$${newPrice.toFixed(2)} for ${signals} Signals`;
        }

        // Initial price update
        modelSelects.forEach(select => updatePrices(select));

        // Event listeners for model selection changes
        modelSelects.forEach(select => {
            select.addEventListener('change', function() {
                updatePrices(this);
            });
        });
    });
    </script>
{% endblock %} 